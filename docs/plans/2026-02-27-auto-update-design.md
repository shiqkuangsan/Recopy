# Auto Update Design

Related: FR-005

## Overview

Implement automatic version checking and in-app update for Recopy. The app checks GitHub Releases for new versions, displays an update prompt in the main panel, and allows users to download, install, and restart — all without leaving the app.

## Technical Stack

- **Backend plugin**: `tauri-plugin-updater` (official Tauri v2 updater)
- **Process control**: `tauri-plugin-process` (provides `relaunch()`)
- **Update source**: GitHub Releases — `latest.json` auto-generated by `tauri-action`
- **Signing**: Ed25519 key pair (Tauri's own signing, not Apple/Windows code signing)
- **No custom server required**

## Architecture

### Update Flow

```
App startup
  → Silent check (GET latest.json from GitHub Releases)
  → Compare remote version vs local version
  → New version found → Update store status = "available"
  → UI shows update prompt in main panel title bar
  → User clicks → Download with progress callback
  → Download complete → "Restart to update" button
  → User clicks restart → relaunch()
```

### Periodic Check

- First check on app startup
- Subsequent checks based on user-configured interval (default: weekly)
- Intervals: `daily` / `weekly` / `monthly` / `never`
- `never` disables automatic checking entirely
- Timer managed in `App.tsx` via `setInterval`

## Frontend

### Update Store (`src/stores/update-store.ts`)

Zustand store managing update lifecycle:

```typescript
interface UpdateStore {
  status: 'idle' | 'checking' | 'available' | 'downloading' | 'ready' | 'error'
  version: string | null       // New version number
  body: string | null           // Release notes
  progress: number              // 0-100 download percentage
  checkForUpdate: () => void
  downloadAndInstall: () => void
  relaunch: () => void
}
```

### UI Component (`UpdateBanner.tsx`)

Embedded in the main panel title bar, to the right of the "Recopy" title.

**State transitions:**

| Status | Display | Interaction |
|--------|---------|-------------|
| `idle` / `checking` | Nothing visible | — |
| `available` | `v0.4.0 available` + pulse dot animation | Click to download |
| `downloading` | Inline progress bar + percentage | Click to cancel (optional) |
| `ready` | `Restart to update` button with breathing animation | Click to restart |
| `error` | Silent — no user-facing error | — |

**Animation details:**
- Available state: small pulsing dot (Tailwind `animate-pulse`) next to version text
- Download progress: thin inline progress bar, theme accent color, width grows with progress
- Ready state: button with subtle breathing animation to draw attention

**Design principles:**
- Non-intrusive — never blocks clipboard usage
- No modal dialogs — everything inline in the title bar
- No "skip this version" — keep it simple, ignore = dismiss until next check cycle
- Follows existing glassmorphism style, adapts to light/dark theme

### Check Logic (in `App.tsx`)

- On mount: trigger first update check
- Read `update_check_interval` from settings store
- Start `setInterval` based on interval setting
- All results written to update store

## Backend

### New Dependencies

**Cargo.toml:**
- `tauri-plugin-updater`
- `tauri-plugin-process`

**package.json:**
- `@tauri-apps/plugin-updater`
- `@tauri-apps/plugin-process`

### Plugin Registration (`lib.rs`)

Register both plugins in the app builder:
- `tauri_plugin_updater`
- `tauri_plugin_process`

### Tauri Configuration (`tauri.conf.json`)

```json
{
  "bundle": {
    "createUpdaterArtifacts": "v2Compatible"
  },
  "plugins": {
    "updater": {
      "pubkey": "<Ed25519 public key>",
      "endpoints": [
        "https://github.com/shiqkuangsan/Recopy/releases/latest/download/latest.json"
      ]
    }
  }
}
```

### Capabilities (`default.json`)

Add permissions:
- `updater:default`
- `process:allow-restart`

### New Setting

| Key | Default | Options | Description |
|-----|---------|---------|-------------|
| `update_check_interval` | `weekly` | `daily` / `weekly` / `monthly` / `never` | How often to check for updates |

Displayed in Settings page under the "About" section.

## CI/CD

### One-time Setup

1. Generate Ed25519 key pair:
   ```bash
   pnpm tauri signer generate -w ~/.tauri/recopy.key
   ```
2. Add to GitHub repo Secrets:
   - `TAURI_SIGNING_PRIVATE_KEY` — private key content
   - `TAURI_SIGNING_PRIVATE_KEY_PASSWORD` — private key password
3. Write public key to `tauri.conf.json` `plugins.updater.pubkey`

### release.yml Changes

```yaml
- uses: tauri-apps/tauri-action@v0
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
    TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
  with:
    includeUpdaterJson: true
```

`tauri-action` automatically:
1. Signs update bundles (`.tar.gz.sig` / `.nsis.zip.sig`)
2. Generates `latest.json` with platform download URLs + signatures
3. Uploads all artifacts to GitHub Release

Existing build matrix (macOS aarch64 + Windows x64) remains unchanged.

## Files Changed

| File | Change |
|------|--------|
| `src-tauri/Cargo.toml` | Add `tauri-plugin-updater`, `tauri-plugin-process` |
| `src-tauri/tauri.conf.json` | Add `createUpdaterArtifacts`, `plugins.updater` config |
| `src-tauri/capabilities/default.json` | Add `updater:default`, `process:allow-restart` |
| `src-tauri/src/lib.rs` | Register updater + process plugins |
| `package.json` | Add `@tauri-apps/plugin-updater`, `@tauri-apps/plugin-process` |
| `src/stores/update-store.ts` | **New** — Zustand store for update state |
| `src/components/UpdateBanner.tsx` | **New** — Inline update UI component |
| `src/App.tsx` | Mount UpdateBanner, startup check + interval timer |
| `src/components/SettingsPage.tsx` | Add update interval config option |
| `src/i18n/locales/zh.json` | Add update-related i18n keys |
| `src/i18n/locales/en.json` | Add update-related i18n keys |
| `.github/workflows/release.yml` | Add signing env vars + `includeUpdaterJson` |

## App Store Compatibility

The updater is gated behind a compile-time Cargo feature flag so that App Store builds (which prohibit self-update mechanisms) can cleanly exclude it.

### Cargo Feature

```toml
[features]
default = ["self-update"]
self-update = ["tauri-plugin-updater", "tauri-plugin-process"]
```

### Conditional Plugin Registration (`lib.rs`)

```rust
#[cfg(feature = "self-update")]
{
    builder = builder
        .plugin(tauri_plugin_updater::init())
        .plugin(tauri_plugin_process::init());
}
```

### Build Pipelines

| Channel | Feature | Update mechanism |
|---------|---------|------------------|
| GitHub Release (direct distribution) | `self-update` enabled | tauri-plugin-updater, checks GitHub |
| App Store (future) | `self-update` disabled | App Store handles updates natively |

### Frontend Graceful Degradation

The update store wraps updater API calls in try-catch. When the plugin is absent (App Store build), the UpdateBanner simply does not render — no errors, no UI.

### Why Feature Flag

- **Apple App Review Guidelines 2.4.5** — Mac App Store apps must not include self-update mechanisms
- **Microsoft Store Policy 10.2** — similar restriction
- Compile-time gating = zero runtime cost, no dead code in Store builds

## Out of Scope

- macOS Apple code signing / notarization (separate effort, needs $99/yr developer account)
- Windows code signing certificate
- "Skip this version" feature
- Delta/incremental updates
- Custom update server
