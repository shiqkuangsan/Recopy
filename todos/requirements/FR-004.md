# FR-004: NSPanel 非激活面板（macOS）

## 基本信息

- **优先级**：P0
- **状态**：待开发
- **关联**：FR-001, BUG-001, M5-5, M8-6
- **依赖**：无

## 背景

当前 EasyCV 使用标准 `NSWindow`，呼出面板时 macOS 会将 EasyCV 设为"激活应用"，导致：
1. 之前的前台应用丢失焦点，模拟粘贴发送给 EasyCV 自身（BUG-001）
2. `window.hide()` 后标题栏仍显示 EasyCV，焦点不回退（FR-001）
3. 面板无法浮在 Dock 之上

竞品 Paste 使用 `NSPanel + NonactivatingPanel` 从根本上解决了这些问题。

## 调研结论

- **tauri-nspanel** v2.1（[ahkohd/tauri-nspanel](https://github.com/ahkohd/tauri-nspanel)，375 stars）
- 完全支持 Tauri v2，EcoPaste / Cap / Screenpipe 等项目已验证
- 当前 EasyCV Tauri 版本 2.10.2 > 插件要求 2.8.5，兼容
- 未发布 crates.io，需 GitHub git 引用

## 需求描述

1. 将主面板窗口从 `NSWindow` 转换为 `NSPanel`
2. 设置 `NonactivatingPanel` style mask，面板不激活 App
3. 设置 `PanelLevel::Dock`（level 20），面板浮在 Dock 之上
4. 键盘事件正常工作（搜索、方向键、Enter、Escape）
5. 粘贴流程改为 `resign_key_window()` → 模拟 Cmd+V → 隐藏面板

## 实现方案

### 依赖

```toml
# src-tauri/Cargo.toml
[target."cfg(target_os = \"macos\")".dependencies]
tauri-nspanel = { git = "https://github.com/ahkohd/tauri-nspanel", branch = "v2.1" }
```

### 面板定义（EcoPaste 模式）

```rust
use tauri_nspanel::{tauri_panel, CollectionBehavior, PanelLevel, StyleMask, WebviewWindowExt};

tauri_panel! {
    panel!(EasyCVPanel {
        config: {
            is_floating_panel: true,
            can_become_key_window: true,
            can_become_main_window: false
        }
    })

    panel_event!(EasyCVPanelEventHandler {
        window_did_become_key(notification: &NSNotification) -> (),
        window_did_resign_key(notification: &NSNotification) -> (),
    })
}
```

### 初始化

```rust
// 注册插件
app.plugin(tauri_nspanel::init());

// 转换窗口
let panel = main_window.to_panel::<EasyCVPanel>().unwrap();

// 配置
panel.set_level(PanelLevel::Dock.value());
panel.set_style_mask(StyleMask::empty().nonactivating_panel().resizable().into());
panel.set_collection_behavior(
    CollectionBehavior::new()
        .stationary()
        .move_to_active_space()
        .full_screen_auxiliary()
        .into(),
);
```

### 粘贴流程

```rust
// 旧流程：window.hide() → simulate_paste()
// 新流程：
panel.resign_key_window();   // 焦点回到前台 App
simulate_paste();            // Cmd+V 发到正确的 App
panel.hide();                // 隐藏面板
```

## 影响范围

- 从根本上解决 FR-001（焦点回退）
- 大幅改善 BUG-001（模拟粘贴可靠性）
- 实现窗口浮在 Dock 之上
- **仅限 macOS**，Windows 路径不变

## 验收标准

- [ ] 呼出面板时，之前的 App 不丢失焦点（macOS 标题栏不变为 EasyCV）
- [ ] 键盘导航正常：方向键、Enter 粘贴、Escape 关闭、搜索输入
- [ ] 粘贴操作：选中 → Enter → 内容粘贴到前台 App 的光标处
- [ ] 面板浮在 Dock 之上
- [ ] 面板出现在所有桌面空间
- [ ] Windows 平台不受影响，编译正常

## 注意事项

- `NonactivatingPanel` style mask 必须在创建时设置，运行时修改可能不生效
- `canBecomeKeyWindow: true` 是键盘事件的前提
- 需要 `macOS-private-api` feature（已启用）
